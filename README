This is a fork of https://gist.github.com/996827 with some heavy modifications.